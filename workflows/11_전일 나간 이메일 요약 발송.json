{"createdAt":"2024-11-20T05:46:38.268Z","updatedAt":"2024-12-20T03:05:23.000Z","id":"xGdv4X5B1xMT6qVb","name":"11_전일 나간 이메일 요약 발송","active":true,"nodes":[{"parameters":{"mode":"runOnceForEachItem","jsCode":"const timestamp = new Date($json[\"timestamp\"]);\n\n// Set today 9 AM\nconst today9am = new Date(timestamp);\ntoday9am.setUTCHours(0, 0, 0, 0);\ntoday9am.setDate(today9am.getDate()); // Move to the previous day for \"today\"\n\n// Set yesterday 9 AM\nconst yesterday9am = new Date(today9am);\nyesterday9am.setDate(yesterday9am.getDate() - 1); // Move to the day before \"yesterday\"\n\n// Format to ISO 8601 without milliseconds\nconst formattedToday = today9am.toISOString().split('.')[0] + 'Z';\nconst formattedYesterday = yesterday9am.toISOString().split('.')[0] + 'Z';\n\nreturn {\n  today: formattedToday,\n  yesterday: formattedYesterday\n};\n"},"id":"916ba0ca-4b07-46aa-b0d4-f513059b14f2","name":"어제와 오늘 날짜 계산","type":"n8n-nodes-base.code","typeVersion":2,"position":[2840,480],"notes":"어제와 오늘 날짜를 ISO 형식으로 계산합니다."},{"parameters":{"url":"={{ $vars.gpters_internal_api_endpoint }}/emails/logs/group","sendQuery":true,"queryParameters":{"parameters":[{"name":"startDate","value":"={{ $json.yesterday }}"},{"name":"endDate","value":"={{ $json.today }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"={{ $vars.gpters_internal_api_token_key }}","value":"={{ $vars.gpters_internal_api_token }}"}]},"options":{}},"id":"0fa1bee3-2865-45d5-8101-7854528ea833","name":"전일 이메일 로그 조회","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3080,480],"notes":"내부 API를 호출하여 전일 발송된 이메일 로그를 가져옵니다."},{"parameters":{"jsCode":"// 이메일 아이템 배열 추출\nconst emailItems = items[0].json.items;\n\n// 이메일 요약 배열 초기화\nlet emailSummaries = [];\n\n// 이메일 아이템이 있는지 확인\nif (!emailItems || !Array.isArray(emailItems)) {\n  throw new Error('유효한 이메일 데이터가 없습니다.');\n}\n\n// 각 이메일 아이템 처리\nemailItems.forEach(emailItem => {\n  const emailId = emailItem.emailId;\n\n  const transactionId = emailItem.transactionId;\n  const count = emailItem.count;\n  const subject = emailItem.preview.subject;\n  let htmlContent = emailItem.preview.htmlContent;\n\n  // 기존에 텍스트 변환, 링크 추출 등 요약을 했던 부분을 모두 생략\n  // 원문 HTML을 그대로 담을 경우 그냥 htmlContent를 사용하면 됩니다.\n\n  const summary = {\n    emailId,\n    transactionId,\n    count,\n    subject,\n    // 여기서 htmlContent를 그대로 content로 사용\n    content: htmlContent\n  };\n  emailSummaries.push(summary);\n});\n\n// 총 이메일 수와 총 발송 수 계산\nconst totalEmails = emailSummaries.length;\nconst totalSent = emailSummaries.reduce((sum, email) => sum + email.count, 0);\n\n// 어제 날짜 포맷팅\nconst yesterday = new Date();\nyesterday.setDate(yesterday.getDate() - 1);\nconst formattedDate = yesterday.toISOString().split('T')[0];\n\n// 이메일 내용을 최종적으로 묶는 부분\n// 이제 각 이메일 항목에 대해 summary.content에 담긴 HTML 그대로를 넣을 수 있습니다.\nlet emailContent = `\n<!DOCTYPE html>\n<html lang=\"ko\">\n<head>\n<meta charset=\"UTF-8\">\n<title>전일 발송된 이메일 원문 목록</title>\n<style>\n  body {\n    font-family: Arial, sans-serif;\n    line-height: 1.6;\n    max-width: 800px;\n    margin: 0 auto;\n    padding: 20px;\n  }\n  .email-entry {\n    margin-bottom: 30px;\n    padding: 20px;\n    background-color: #f9f9f9;\n    border-left: 4px solid #007bff;\n    border-radius: 4px;\n  }\n  .email-subject {\n    font-size: 1.2em;\n    font-weight: bold;\n    color: #007bff;\n    margin-bottom: 20px;\n  }\n  .email-meta {\n    font-size: 0.9em;\n    color: #666;\n    margin-bottom: 20px;\n    white-space: pre-line;\n  }\n</style>\n</head>\n<body>\n<h2>전일 발송된 이메일 원문 목록 (${formattedDate})</h2>\n`;\n\nif (emailSummaries.length > 0) {\n  emailSummaries.forEach(summary => {\n    // summary.content에는 원문 HTML이 들어있음\n    emailContent += `\n<div class=\"email-entry\">\n  <div class=\"email-subject\">${summary.subject}</div>\n  <div class=\"email-meta\">\n    📋 이메일 ID: ${summary.emailId}<br>\n    🔍 트랜잭션 ID: ${summary.transactionId}<br>\n    📨 발송 수: ${summary.count}건\n  </div>\n  <div class=\"email-content\">\n    ${summary.content}\n  </div>\n</div>`;\n  });\n\n  emailContent += `\n<div class=\"summary\" style=\"margin-top:30px;padding:20px;background-color:#e9ecef;border-radius:4px;\">\n  <h3>발송 요약</h3>\n  <p>📊 총 이메일 종류: ${totalEmails}개<br>\n  📬 총 발송 수: ${totalSent}건</p>\n</div>`;\n} else {\n  emailContent += '<p>전일 발송된 이메일이 없습니다.</p>';\n}\n\nemailContent += `\n</body>\n</html>\n`;\n\nreturn [\n  {\n    json: {\n      emailContent: emailContent\n    }\n  }\n];\n"},"id":"62934ff2-1166-4a92-ac98-9667e42a49db","name":"이메일 요약 생성","type":"n8n-nodes-base.code","typeVersion":2,"position":[3740,480],"notes":"이메일 로그 데이터를 처리하여 요약 메일 내용을 생성합니다."},{"parameters":{"method":"POST","url":"={{ $vars.gpters_internal_api_endpoint }}/emails","sendHeaders":true,"headerParameters":{"parameters":[{"name":"={{ $vars.gpters_internal_api_token_key }}","value":"={{ $vars.gpters_internal_api_token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $json.emailContent }}"},{"name":"preview","value":"={{ $('어제와 오늘 날짜 계산').item.json.yesterday.slice(0,10) }}에 보내진 이메일 요약입니다."},{"name":"bcc","value":"={{ [JSON.stringify(\"all@gpters.org\") ]}}"},{"name":"title","value":"={{ $('어제와 오늘 날짜 계산').item.json.yesterday.slice(0,10) }}에 보내진 이메일 요약입니다."}]},"options":{}},"id":"fbb2101c-dce3-4005-98d4-48230f6ee35d","name":"요약 이메일 발송","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3960,480],"notes":"생성된 이메일 요약 내용을 내부 API를 통해 팀에게 발송합니다."},{"parameters":{"assignments":{"assignments":[{"id":"7ea6ec51-126a-4771-8603-55627af4fbf0","name":"text","value":"={{ $('어제와 오늘 날짜 계산').item.json.yesterday.slice(0,10) }}에 보낸 이메일에 대한 요약 메일을 발송하였습니다.","type":"string"}]},"options":{}},"id":"3a43f84e-ac2b-46a8-9371-7a2c5681dde0","name":"상태 메시지 설정","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4400,480],"notes":"요약 이메일 발송 후 상태 메시지를 설정합니다."},{"parameters":{"workflowId":{"__rl":true,"value":"XVWUaUPaaiGofxQ6","mode":"list","cachedResultName":"GPTers — slackNoti_airtable"},"options":{}},"id":"f71bfe55-6a99-41e7-8990-54662b131b38","name":"슬랙 알림 전송","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.1,"position":[4620,480],"notes":"요약 이메일 발송 완료를 슬랙에 알립니다."},{"parameters":{"rule":{"interval":[{"triggerAtHour":9}]}},"id":"69e4d2c2-6147-458e-abdf-ce8a81a49e4a","name":"매일 오전 9시 트리거","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[2620,480],"notes":"매일 오전 8시에 워크플로우를 시작합니다."},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"665b4a80-8a2c-48f8-9acd-57ad3e2f0c33","leftValue":"={{ $json.rejected }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"id":"fba09fb0-8581-4ab3-8ac3-ad11b344b814","name":"If","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4180,480]},{"parameters":{"workflowId":{"__rl":true,"value":"XVWUaUPaaiGofxQ6","mode":"list","cachedResultName":"GPTers — slackNoti_airtable"},"options":{}},"id":"99bd5eb7-007c-4acf-9a8d-09aca27be3f7","name":"슬랙 알림 전송1","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.1,"position":[4620,680],"notes":"요약 이메일 발송 완료를 슬랙에 알립니다."},{"parameters":{"assignments":{"assignments":[{"id":"7ea6ec51-126a-4771-8603-55627af4fbf0","name":"text","value":"=이메일에 대한 요약 메일을 발송을 실패하였습니다.","type":"string"}]},"options":{}},"id":"abfec763-f22a-4771-a0b3-4cbbe445ad2e","name":"에러 상태 메시지 설정","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4400,680],"notes":"요약 이메일 발송 후 상태 메시지를 설정합니다."},{"parameters":{"content":"\n\n\n\n\n\n\n\n\n\n\n\n## 이메일이 발송되지 않았을 때 예외처리","height":223.47674418604663,"width":473.54651162790697,"color":7},"id":"79526a69-6720-4949-8205-63593b3f3d9d","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[4280,660]},{"parameters":{"content":"## 날짜 데이터 전처리","height":222.37406055019858,"width":392.6523060833808},"id":"32bcbfeb-e1bb-4b81-b402-b64409de3657","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2580,400]},{"parameters":{"content":"## 이메일 로그 조회 후 이메일 요약을 생성하여 all@gpters.org로 발송","height":283.10669845433944,"width":609.3200953630171},"id":"82e58316-43ce-4426-8c45-03d9874d22e0","name":"Sticky Note2","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[3040,380]},{"parameters":{"content":"## 이메일 성공적으로 발송 후 슬랙 알림","height":325.7836872518435,"width":514.1175818916616},"id":"6badf5d4-22e9-44b6-a0e5-9e585d9a00ba","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[3920,320]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6f7b74f7-8a49-4f63-80d7-7dc19dbe4ae0","leftValue":"={{ $json.items }}","rightValue":"","operator":{"type":"array","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"id":"788f64e4-079e-434c-97c2-75727ac422db","name":"If1","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3300,480]},{"parameters":{},"id":"4eb1a9f2-87dc-42c6-a480-f8b580b51529","name":"전일 이메일 없으면 두낫띵","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3740,660]}],"connections":{"어제와 오늘 날짜 계산":{"main":[[{"node":"전일 이메일 로그 조회","type":"main","index":0}]]},"전일 이메일 로그 조회":{"main":[[{"node":"If1","type":"main","index":0}]]},"이메일 요약 생성":{"main":[[{"node":"요약 이메일 발송","type":"main","index":0}]]},"요약 이메일 발송":{"main":[[{"node":"If","type":"main","index":0}]]},"상태 메시지 설정":{"main":[[{"node":"슬랙 알림 전송","type":"main","index":0}]]},"매일 오전 9시 트리거":{"main":[[{"node":"어제와 오늘 날짜 계산","type":"main","index":0}]]},"If":{"main":[[{"node":"상태 메시지 설정","type":"main","index":0}],[{"node":"에러 상태 메시지 설정","type":"main","index":0}]]},"에러 상태 메시지 설정":{"main":[[{"node":"슬랙 알림 전송1","type":"main","index":0}]]},"If1":{"main":[[{"node":"이메일 요약 생성","type":"main","index":0}],[{"node":"전일 이메일 없으면 두낫띵","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","saveManualExecutions":false,"callerPolicy":"workflowsFromSameOwner","errorWorkflow":"2FkHbmnpOA9Y42fo"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:매일 오전 8시 트리거":{"recurrenceRules":[]},"node:매일 오전 9시 트리거":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"매일 오전 9시 트리거":[{"json":{"timestamp":"2024-12-20T09:00:22.006+09:00","Readable date":"December 20th 2024, 9:00:22 am","Readable time":"9:00:22 am","Day of week":"Friday","Year":"2024","Month":"December","Day of month":"20","Hour":"09","Minute":"00","Second":"22","Timezone":"Asia/Seoul (UTC+09:00)"}}]},"versionId":"9c2227c1-e72b-453d-afec-603f00c844b1","triggerCount":1,"tags":[{"createdAt":"2024-10-30T08:32:06.157Z","updatedAt":"2024-10-30T08:32:06.157Z","id":"6XNkyT4y92x85aDE","name":"이메일"}]}